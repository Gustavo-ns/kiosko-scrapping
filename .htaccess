# -------------------------------------
# COMPRESIÓN GZIP (mejora velocidad)
# -------------------------------------
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE image/svg+xml
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# -------------------------------------
# URLs AMIGABLES
# -------------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Evitar bucles de redirección para archivos que existen
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]
      # Evitar bucles para directorios que existen
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
      # Permite acceso directo a carpetas específicas
    RewriteRule ^(public|images|favicon|css|js|vendor|scripts)/ - [L]
    
    # Test rule
    RewriteRule ^test-rewrite/?$ test-rewrite.php [L]
    RewriteRule ^test-rewrite/?$ test/test-rewrite.php [L]
    
    # URLs amigables específicas
    RewriteRule ^home/?$ src/index.php [L]
    RewriteRule ^resumen/?$ src/resumen.php [L]
    RewriteRule ^api/?$ src/api.php [L]
    RewriteRule ^importar/?$ scripts/importar_enlaces.php [L]
    
    # APIs para AJAX calls
    RewriteRule ^api/update-record/?$ scripts/update_record.php [L]
    RewriteRule ^api/grupos/?$ scripts/get_grupos.php [L]
    RewriteRule ^api/clear-records/?$ scripts/clear_records.php [L]
    RewriteRule ^api/add-record/?$ scripts/add_record.php [L]
    RewriteRule ^api/update-visibility/?$ scripts/update_visibility.php [L]
    RewriteRule ^api/update-melwater/?$ scripts/update_melwater.php [L]
    RewriteRule ^api/process-bulk-links/?$ scripts/process_bulk_links.php [L]
    RewriteRule ^scrape/?$ scrape.php [L]
    
    # Async scraping API endpoints
    RewriteRule ^api/scrape/start/?$ public/index.php?route=scrape/start [L]
    RewriteRule ^api/scrape/stop/?$ public/index.php?route=scrape/stop [L]
    RewriteRule ^api/scrape/status/?$ public/index.php?route=scrape/status [L]
    
    # Redirigir la raíz al home
    RewriteRule ^$ home [L,R=301]
    
    # URLs amigables genéricas - buscar archivos .php en src/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/(src|public|images|favicon|css|js|vendor|scripts)/
    RewriteRule ^([^/]+)/?$ src/$1.php [L]
    
    # Si no encuentra nada, redirigir al home
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ home [L,R=301]
</IfModule>

# -------------------------------------
# CACHE DE RECURSOS ESTÁTICOS
# -------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # Imágenes
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fuentes
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"

  # CSS y JS
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
</IfModule>

<IfModule mod_headers.c>
  <FilesMatch "\.(js|css|jpg|jpeg|png|gif|webp|woff2|woff|svg|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# -------------------------------------
# FORZAR HTTPS (opcional — comenta si no usás HTTPS)
# -------------------------------------
<IfModule mod_rewrite.c>
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP_HOST} !^localhost [NC]
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# -------------------------------------
# CORS en fuentes (por si usás CDN o fuentes externas)
# -------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css|css|js)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
</IfModule>

# -------------------------------------
# SEGURIDAD BÁSICA
# -------------------------------------
# Ocultar archivos sensibles
<FilesMatch "(\.env|\.git|composer\.(json|lock)|package\.json|webpack\.config\.js|\.htaccess)">
  Order Allow,Deny
  Deny from all
</FilesMatch>

# php -- BEGIN cPanel-generated handler, do not edit
# Set the "ea-php83" package as the default "PHP" programming language.
<IfModule mime_module>
  #AddHandler application/x-httpd-ea-php83___lsphp .php .php8 .phtml
</IfModule>
# php -- END cPanel-generated handler, do not edit
